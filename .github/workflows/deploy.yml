name: Deploy PongLab

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    name: Deploy to Server
    runs-on: [ponglab]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- Generate .env files safely ---
      - name: Create backend .env
        run: |
          mkdir -p backend
          echo "DOMAIN=${{ vars.DOMAIN }}" > backend/.env
          echo "SERVER_PORT=3001" >> backend/.env
          echo "FRONTEND_PORT=5173" >> backend/.env
          echo "NODE_ENV=production" >> backend/.env

      - name: Create frontend .env
        run: |
          mkdir -p frontend
          echo "VITE_DOMAIN=${{ vars.DOMAIN }}" > frontend/.env
          echo "VITE_SERVER_PORT=3001" >> frontend/.env
          echo "VITE_FRONTEND_PORT=5173" >> frontend/.env

      - name: Create .env
        run: |
          echo "DOMAIN=${{ vars.DOMAIN }}" > .env
          echo "SERVER_PORT=3001" >> .env
          echo "FRONTEND_PORT=5173" >> .env
          echo "NODE_ENV=production" >> .env

      - name: Debug .env files
        run: |
          echo "--- backend/.env ---"
          cat backend/.env
          echo "--- frontend/.env ---"
          cat frontend/.env
          echo "--- .env ---"
          cat .env

      # Optional: print env for debugging
      - name: Debug env files
        run: |
          echo "Generated environment files:"
          echo "Backend .env:"
          cat backend/.env
          echo "Frontend .env:"
          cat frontend/.env

      # --- Stop containers safely ---
      - name: Stop existing containers
        run: |
          docker-compose down || true
          docker container prune -f || true

      # --- Build + start ---
      - name: Build and start services
        run: |
          docker-compose up --build -d

      # --- Wait a bit ---
      - name: Wait for services
        run: |
          echo "Waiting for services to start..."
          sleep 5

      # --- Verify deployment ---
      - name: Verify deployment
        run: |
          docker-compose ps

      # --- Logs on failure ---
      - name: Show service logs if failed
        if: failure()
        run: |
          echo "===== Containers ====="
          docker-compose ps
          echo "===== Logs ====="
          docker-compose logs --tail=100
